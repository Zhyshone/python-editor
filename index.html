<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Python Terminal Editor</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>

<style>
html,body{height:100%;margin:0;font-family:monospace;background:#0f1113;color:#ddd;}
.container{display:flex;height:100vh;}
.left{width:50%;display:flex;flex-direction:column;border-right:1px solid #222;background:#1b1d1f;}
.right{width:50%;display:flex;flex-direction:column;background:#0b0c0d;}
.titlebar{display:flex;justify-content:space-between;padding:10px;background:#151617;border-bottom:1px solid #222;}
.btn{border:none;padding:7px 12px;border-radius:6px;cursor:pointer;font-weight:600;}
.btn-run{background:#0e8b3b;color:#fff;}
.btn-clear{background:transparent;color:#fff;border:1px solid #333;}
.editor-area{flex:1;display:flex;}
.CodeMirror{height:100%;width:100%;font-size:14px;background:#0f1113;color:#ddd;}
.console-header{padding:10px;border-bottom:1px solid #111;color:#9aa5b1;}
.console{flex:1;padding:12px;overflow:auto;white-space:pre-wrap;background:#0b0c0d;color:#00ff88;outline:none;caret-color:#00ff88;}
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <div class="titlebar">
      <div>Python Editor</div>
      <div>
        <button class="btn btn-run" id="runBtn">Run â–¶</button>
        <button class="btn btn-clear" id="clearBtn">ðŸ—‘</button>
      </div>
    </div>
    <div class="editor-area">
      <textarea id="code">
# Example
name = input("Enter your name: ")
print("Hello,", name)
      </textarea>
    </div>
  </div>
  <div class="right">
    <div class="console-header">Terminal</div>
    <div id="console" class="console" contenteditable="true"></div>
  </div>
</div>

<script>
const consoleEl = document.getElementById('console');
let pyodideReady = false;
let pyodide = null;
let inputResolve = null;
let inputBuffer = '';

// Append text to console
function appendConsole(text){consoleEl.textContent += text; consoleEl.scrollTop = consoleEl.scrollHeight;}
function appendConsoleLine(text=''){appendConsole(text+'\n'); placeCaretEnd(consoleEl);}
function placeCaretEnd(el){el.focus(); const sel=window.getSelection(); const range=document.createRange(); range.selectNodeContents(el); range.collapse(false); sel.removeAllRanges(); sel.addRange(range);}

// Initialize CodeMirror
const editor = CodeMirror.fromTextArea(document.getElementById('code'),{
  mode:'python', theme:'dracula', lineNumbers:true, indentUnit:4, tabSize:4
});
editor.setSize('100%','100%');

// Load Pyodide
async function initPyodide(){
  appendConsoleLine("Loading Python...");
  pyodide = await loadPyodide();
  pyodideReady = true;

  // Override sys.stdin with our terminal class
  await pyodide.runPythonAsync(`
import sys
class ConsoleInput:
    def __init__(self):
        self.buffer = ""
        self.resolve = None
    async def readline(self):
        from js import create_input
        return await create_input()
sys.stdin = ConsoleInput()
`);

  // Expose JS function for Python to await
  pyodide.globals.set("create_input", async () => {
    return await new Promise(resolve => {
      inputResolve = resolve;
      inputBuffer = '';
      placeCaretEnd(consoleEl);
    });
  });

  appendConsoleLine("Python ready.\n");
}
initPyodide();

// Capture key input
consoleEl.addEventListener('keydown', e=>{
  if(!inputResolve) return;
  if(e.key==='Enter'){
    e.preventDefault();
    appendConsoleLine('');
    inputResolve(inputBuffer+'\n');
    inputResolve=null;
  } else if(e.key==='Backspace'){
    e.preventDefault();
    if(inputBuffer.length>0){
      inputBuffer=inputBuffer.slice(0,-1);
      consoleEl.textContent=consoleEl.textContent.slice(0,-1);
      placeCaretEnd(consoleEl);
    }
  } else if(e.key.length===1){
    e.preventDefault();
    inputBuffer+=e.key;
    appendConsole(e.key);
  }
});

// Run / Clear buttons
document.getElementById('runBtn').addEventListener('click',async()=>{
  if(!pyodideReady){appendConsoleLine("Python not ready"); return;}
  appendConsoleLine('--- Running ---\n');
  try{
    await pyodide.runPythonAsync(editor.getValue());
  }catch(err){appendConsoleLine('Error:\n'+err+'\n');}
  appendConsoleLine('--- Finished ---\n');
});
document.getElementById('clearBtn').addEventListener('click',()=>{consoleEl.textContent='';});
</script>
</body>
</html>
